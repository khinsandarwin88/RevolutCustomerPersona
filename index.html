<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolut Horizons: Your Financial Navigator</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&family=Verdana:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS: Theme Variables */
        :root {
            /* Celestial Aura (Default) */
            --bg-gradient-start: #0f0a20;
            --bg-gradient-end: #1a0a2e;
            --header-color: #00ffcc;
            --header-shadow: rgba(0, 255, 204, 0.5);
            --card-bg: #251838;
            --card-border: #8e44ad;
            --card-shadow: rgba(0, 255, 204, 0.5);
            --h2-color: #ff66b2;
            --label-color: #00ffcc;
            --input-bg: #2b1c40;
            --input-border: #8e44ad;
            --input-focus-border: #00ffcc;
            --input-shadow: rgba(0, 255, 204, 0.2);
            --input-focus-shadow: rgba(0, 255, 204, 0.4);
            --button-bg: #4a2d73;
            --button-hover-bg: #6a40a3;
            --button-shadow: rgba(74, 45, 115, 0.5);
            --button-hover-shadow: #ff66b2;
            --text-color-light: #e0e0e0;
            --goal-display-border: #00ffcc;
            --goal-display-shadow: rgba(0, 255, 204, 0.5);
            --goal-display-pulse-shadow: #00ffcc;
            --goal-strong-color: #ff66b2;
            --goal-impact-color: #00ffcc;
            --timeline-line-color: #8e44ad;
            --event-border: #ff66b2;
            --event-shadow: rgba(255, 102, 178, 0.3);
            --event-orb-bg: #00ffcc;
            --event-orb-shadow: #00ffcc;
            --event-income-color: #00ffcc;
            --event-expense-color: #ff66b2;
            --delete-button-color: #ff66b2;
            --no-data-color: #8e44ad;
            --talk-to-human-bg: #00ffcc; /* This variable is now less critical as the button is removed */
            --talk-to-human-color: #0f0a20; /* This variable is now less critical as the button is removed */
            --talk-to-human-shadow: #00ffcc; /* This variable is now less critical as the button is removed */
            --modal-bg: #2b1c40;
            --modal-border: #00ffcc;
            --modal-shadow: rgba(0, 255, 204, 0.5);
            --modal-button-bg: #4a2d73;
            --modal-button-hover: #6a40a3;
            --modal-text-color: #e0e0e0;

            /* Base font size for accessibility */
            font-size: 18px;
            --body-font: 'Roboto', sans-serif;
            --header-font: 'Orbitron', sans-serif;

            /* Chat specific colors */
            --chat-bg: #1f143a;
            --chat-header-bg: #3a255b;
            --chat-header-text: #00ffcc;
            --chat-message-user-bg: #4a2d73;
            --chat-message-bot-bg: #2b1c40;
            --chat-input-bg: #1a0a2e;
            --chat-input-border: #8e44ad;
            --chat-send-btn-bg: #00ffcc;
            --chat-send-btn-color: #0f0a20;
            --chat-loading-color: #ff66b2;
        }

        /* Color-Blind Friendly Theme */
        body[data-theme="color-blind"] {
            --bg-gradient-start: #2c2c2c;
            --bg-gradient-end: #1c1c1c;
            --header-color: #ffa500; /* Bright Orange */
            --header-shadow: rgba(255, 165, 0, 0.5);
            --card-bg: #333333;
            --card-border: #555555;
            --card-shadow: rgba(255, 165, 0, 0.5);
            --h2-color: #00bfff; /* Deep Sky Blue */
            --label-color: #ffa500;
            --input-bg: #3c3c3c;
            --input-border: #555555;
            --input-focus-border: #ffa500;
            --input-shadow: rgba(255, 165, 0, 0.2);
            --input-focus-shadow: rgba(255, 165, 0, 0.4);
            --button-bg: #808080;
            --button-hover-bg: #a0a0a0;
            --button-shadow: rgba(128, 128, 128, 0.5);
            --button-hover-shadow: #00bfff;
            --text-color-light: #f0f0f0;
            --goal-display-border: #ffa500;
            --goal-display-shadow: rgba(255, 165, 0, 0.5);
            --goal-display-pulse-shadow: #ffa500;
            --goal-strong-color: #00bfff;
            --goal-impact-color: #ffa500;
            --timeline-line-color: #555555;
            --event-border: #00bfff;
            --event-shadow: rgba(0, 191, 255, 0.3);
            --event-orb-bg: #ffa500;
            --event-orb-shadow: #ffa500;
            --event-income-color: #ffa500;
            --event-expense-color: #00bfff;
            --delete-button-color: #00bfff;
            --no-data-color: #555555;
            --talk-to-human-bg: #ffa500;
            --talk-to-human-color: #1c1c1c;
            --talk-to-human-shadow: #ffa500;
            --modal-bg: #3c3c3c;
            --modal-border: #ffa500;
            --modal-shadow: rgba(255, 165, 0, 0.5);
            --modal-button-bg: #808080;
            --modal-button-hover: #a0a0a0;
            --modal-text-color: #f0f0f0;

            /* Chat specific colors */
            --chat-bg: #222222;
            --chat-header-bg: #444444;
            --chat-header-text: #ffa500;
            --chat-message-user-bg: #666666;
            --chat-message-bot-bg: #333333;
            --chat-input-bg: #2c2c2c;
            --chat-input-border: #555555;
            --chat-send-btn-bg: #ffa500;
            --chat-send-btn-color: #1c1c1c;
            --chat-loading-color: #00bfff;
        }

        /* Elderly-Friendly Theme */
        body[data-theme="elderly"] {
            --bg-gradient-start: #ffffff; /* White background */
            --bg-gradient-end: #f0f0f0; /* Light grey background */
            --header-color: #0056b3; /* Dark Blue */
            --header-shadow: rgba(0, 86, 179, 0.3);
            --card-bg: #ffffff;
            --card-border: #cccccc;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --h2-color: #007bff; /* Standard Blue */
            --label-color: #333333;
            --input-bg: #e9ecef;
            --input-border: #ced4da;
            --input-focus-border: #007bff;
            --input-shadow: rgba(0, 0, 0, 0.05);
            --input-focus-shadow: rgba(0, 123, 255, 0.25);
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
            --button-shadow: rgba(0, 123, 255, 0.25);
            --button-hover-shadow: rgba(0, 86, 179, 0.4);
            --text-color-light: #333333; /* Dark text */
            --goal-display-border: #0056b3;
            --goal-display-shadow: rgba(0, 86, 179, 0.3);
            --goal-display-pulse-shadow: rgba(0, 86, 179, 0.5);
            --goal-strong-color: #cc0000; /* Strong Red */
            --goal-impact-color: #0056b3;
            --timeline-line-color: #999999;
            --event-border: #cccccc;
            --event-shadow: rgba(0, 0, 0, 0.05);
            --event-orb-bg: #007bff;
            --event-orb-shadow: rgba(0, 123, 255, 0.2);
            --event-income-color: #28a745; /* Green */
            --event-expense-color: #dc3545; /* Red */
            --delete-button-color: #dc3545;
            --no-data-color: #6c757d;
            --talk-to-human-bg: #28a745; /* Green for help */
            --talk-to-human-color: #ffffff;
            --talk-to-human-shadow: rgba(40, 167, 69, 0.5);
            --modal-bg: #ffffff;
            --modal-border: #007bff;
            --modal-shadow: rgba(0, 123, 255, 0.2);
            --modal-button-bg: #007bff;
            --modal-button-hover: #0056b3;
            --modal-text-color: #333333;

            font-size: 20px; /* Even larger base font */
            --body-font: 'Verdana', sans-serif;
            --header-font: 'Verdana', sans-serif; /* Simpler header font */

            /* Chat specific colors */
            --chat-bg: #f8f9fa;
            --chat-header-bg: #e9ecef;
            --chat-header-text: #333333;
            --chat-message-user-bg: #e2f0d9; /* Light green */
            --chat-message-bot-bg: #e9ecef; /* Light grey */
            --chat-input-bg: #ffffff;
            --chat-input-border: #ced4da;
            --chat-send-btn-bg: #007bff;
            --chat-send-btn-color: #ffffff;
            --chat-loading-color: #007bff;
        }

        /* General Styles applying theme variables */
        body {
            font-family: var(--body-font);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-color-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            font-size: var(--font-size);
            transition: background 0.5s ease, color 0.5s ease; /* Smooth theme transitions */
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, var(--event-shadow) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, var(--card-shadow) 0%, transparent 50%);
            z-index: -1;
            opacity: 0.8;
            transition: background 0.5s ease, opacity 0.5s ease;
        }

        header {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        header h1 {
            font-family: var(--header-font);
            color: var(--header-color);
            font-size: 2.5em;
            text-shadow: 0 0 15px var(--header-shadow), 0 0 30px var(--header-shadow);
            letter-spacing: 2px;
            margin: 0;
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        .container {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 0 30px var(--card-shadow);
            padding: 30px;
            margin: 20px auto;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            border: 1px solid var(--card-border);
            animation: fadeIn 1s ease-out;
            position: relative;
            z-index: 5;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-family: var(--header-font);
            color: var(--h2-color);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            transition: color 0.5s ease;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--label-color);
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.5s ease;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: calc(100% - 20px);
            padding: 12px;
            margin-top: 5px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color-light);
            font-size: 1em;
            box-shadow: inset 0 0 8px var(--input-shadow);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease, color 0.5s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 15px var(--input-focus-border), inset 0 0 10px var(--input-focus-shadow);
            outline: none;
        }

        button {
            background-color: var(--button-bg);
            color: var(--text-color-light);
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.5s ease;
            display: block;
            width: fit-content;
            margin: 20px auto 0;
            box-shadow: 0 0 10px var(--button-shadow);
            border: 1px solid var(--card-border);
        }

        button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 0 20px var(--button-hover-shadow);
        }

        .goal-display {
            background-color: var(--input-bg);
            border: 1px solid var(--goal-display-border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 15px var(--goal-display-shadow);
            animation: pulseGlow 2s infinite alternate;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        @keyframes pulseGlow {
            from { box-shadow: 0 0 15px var(--goal-display-shadow); }
            to { box-shadow: 0 0 25px var(--goal-display-pulse-shadow); }
        }

        .goal-display p {
            margin: 10px 0;
            font-size: 1.2em;
            color: var(--text-color-light);
            transition: color 0.5s ease;
        }

        .goal-display strong {
            color: var(--goal-strong-color);
            font-size: 1.3em;
            transition: color 0.5s ease;
        }

        .goal-impact {
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--goal-impact-color);
            font-weight: bold;
            transition: color 0.5s ease;
        }

        .timeline {
            margin-top: 30px;
        }

        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
            border-left: 2px dashed var(--timeline-line-color);
            padding-left: 20px;
            transition: border-color 0.5s ease;
        }

        .event-list li {
            background-color: var(--card-bg);
            border: 1px solid var(--event-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 0 15px var(--event-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        .event-list li::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background-color: var(--event-orb-bg);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--event-orb-shadow), 0 0 20px var(--event-orb-shadow);
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }

        .event-list li .event-details {
            flex-grow: 1;
            font-size: 1em;
            color: var(--text-color-light);
            transition: color 0.5s ease;
        }

        .event-list li .event-details strong {
            color: var(--label-color);
            font-size: 1.1em;
            transition: color 0.5s ease;
        }

        .event-list li .event-amount {
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.5s ease;
        }

        .event-list li.expense .event-amount {
            color: var(--event-expense-color);
        }

        .event-list li.income .event-amount {
            color: var(--event-income-color);
        }

        .event-actions {
            display: flex;
            gap: 5px;
            margin-left: 15px;
        }

        .event-list button {
            background: none;
            border: none;
            color: var(--delete-button-color);
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; /* Override general button shadow */
            margin: 0; /* Override general button margin */
        }

        .event-list button.edit-btn {
            color: var(--label-color); /* Teal for edit */
        }

        .event-list button:hover {
            color: white;
            transform: scale(1.1);
        }

        .no-events, .no-goal {
            text-align: center;
            color: var(--no-data-color);
            font-style: italic;
            padding: 20px;
            transition: color 0.5s ease;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 25px var(--modal-shadow);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--modal-border);
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            color: var(--h2-color);
            margin-top: 0;
            font-size: 1.5em;
            transition: color 0.5s ease;
        }

        .modal-content p {
            color: var(--modal-text-color);
            margin-bottom: 25px;
            font-size: 1em;
            transition: color 0.5s ease;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            margin: 0; /* Override default button margin */
            background-color: var(--modal-button-bg);
            color: var(--text-color-light);
            border: 1px solid var(--modal-border);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.5s ease;
        }

        .modal-buttons button:hover {
            background-color: var(--modal-button-hover);
            transform: translateY(-1px);
            box-shadow: 0 0 10px var(--modal-shadow);
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
        }

        .theme-switcher label {
            font-size: 0.9em;
            margin-right: 10px;
            color: var(--text-color-light);
            transition: color 0.5s ease;
        }

        .theme-switcher select {
            width: auto;
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color-light);
            border: 1px solid var(--input-border);
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        /* Chatbot Interface Styles - Now at the top, always visible */
        .chat-section {
            width: 100%;
            display: flex;
            flex-direction: column; /* Align items vertically */
            align-items: center; /* Center the chat container within the section */
            margin-bottom: 25px; /* Space between chat and next section */
        }

        .chat-container {
            width: 90%; /* Occupy full width of its parent container */
            max-width: 700px; /* Limit max width for better readability */
            background-color: var(--chat-bg);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10; /* Ensure it's above other content */
            border: 1px solid var(--chat-header-bg);
            height: 450px; /* Fixed height for always-visible chat */
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        .chat-header {
            background-color: var(--chat-header-bg);
            color: var(--chat-header-text);
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            /* No cursor: pointer or toggle button for always visible */
        }

        .chat-header select {
            width: auto;
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color-light);
            border: 1px solid var(--input-border);
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--chat-header-bg) var(--chat-bg);
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--chat-bg);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--chat-header-bg);
            border-radius: 10px;
            border: 2px solid var(--chat-bg);
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background-color: var(--chat-message-user-bg);
            color: var(--text-color-light);
            border-bottom-right-radius: 2px;
        }

        .chat-message.bot {
            align-self: flex-start;
            background-color: var(--chat-message-bot-bg);
            color: var(--text-color-light);
            border-bottom-left-radius: 2px;
        }

        .chat-input-form {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--chat-input-border);
            background-color: var(--chat-input-bg);
        }

        .chat-input-form input {
            flex-grow: 1;
            margin: 0;
            width: auto; /* Override width: calc(100% - 20px) */
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--chat-input-border);
            background-color: var(--chat-input-bg);
            color: var(--text-color-light);
            font-size: 1em;
            box-shadow: none; /* Override general input shadow */
        }

        .chat-input-form input:focus {
            box-shadow: 0 0 10px var(--chat-header-text);
        }

        .chat-input-form button {
            margin: 0 0 0 10px;
            padding: 10px 15px;
            border-radius: 20px;
            background-color: var(--chat-send-btn-bg);
            color: var(--chat-send-btn-color);
            font-size: 1em;
            transition: background-color 0.2s ease;
            box-shadow: none; /* Override general button shadow */
        }

        .chat-input-form button:hover {
            background-color: var(--chat-header-text);
            transform: none;
            box-shadow: none;
        }

        .chat-loading-indicator {
            align-self: flex-start;
            padding: 10px 15px;
            font-style: italic;
            color: var(--chat-loading-color);
            font-size: 0.9em;
            display: flex; /* Use flex for dots */
            align-items: center;
        }

        .chat-loading-indicator span {
            animation: blink 1.4s infinite;
            font-size: 1.5em; /* Larger dots */
            line-height: 0; /* Adjust line height for vertical alignment */
        }

        .chat-loading-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chat-loading-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 15px;
            justify-content: center;
            border-top: 1px solid var(--chat-input-border);
            background-color: var(--chat-input-bg);
        }

        .quick-actions button {
            background-color: var(--button-bg);
            color: var(--text-color-light);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin: 0; /* Override default button margin */
            box-shadow: 0 2px 5px var(--button-shadow);
            border: none; /* Quick action buttons don't need borders */
        }
        .quick-actions button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--button-hover-shadow);
        }


        /* Responsive adjustments */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2em;
            }
            .container {
                padding: 20px;
                margin: 15px auto;
            }
            label, input, select, button, .goal-display p, .event-list li .event-details {
                font-size: 0.9em;
            }
            .event-list li {
                flex-direction: column;
                align-items: flex-start;
            }
            .event-list li .event-amount {
                margin-top: 5px;
            }
            .event-actions {
                position: absolute;
                top: 10px;
                right: 10px;
                margin-left: 0;
            }
            .theme-switcher {
                top: 10px;
                left: 10px;
            }
            .theme-switcher label, .theme-switcher select {
                font-size: 0.8em;
                padding: 6px 10px;
            }
            .chat-container {
                width: 95%; /* Make it wider on small screens */
                height: 350px; /* Adjust height for smaller screens */
                margin: 15px auto;
            }
            .chat-header {
                padding: 10px;
                font-size: 1em;
            }
            .chat-header select {
                padding: 4px 8px;
                font-size: 0.8em;
            }
            .chat-messages {
                padding: 10px;
                gap: 8px;
            }
            .chat-message {
                font-size: 0.85em;
            }
            .chat-input-form {
                padding: 10px;
            }
            .chat-input-form input, .chat-input-form button {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .quick-actions {
                padding: 8px 10px;
                gap: 8px;
            }
            .quick-actions button {
                font-size: 0.75em;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body data-theme="celestial-aura">
    <div class="theme-switcher">
        <label for="themeSelect">Theme:</label>
        <select id="themeSelect">
            <option value="celestial-aura">Celestial Aura</option>
            <option value="color-blind">Color-Blind Friendly</option>
            <option value="elderly">Elderly-Friendly</option>
        </select>
    </div>

    <header>
        <h1>Revolut Horizons</h1>
        <p>Your Personal Financial Navigator</p>
    </header>

    <!-- Chatbot Interface - Now integrated directly into the main content flow -->
    <section class="chat-section">
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <span>Revolut Assistant</span>
                <select id="languageSelect">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="bn">বাংলা</option>
                    <option value="zh">中文</option>
                </select>
            </div>
            <div id="chatMessages" class="chat-messages">
                <!-- Chat messages will be added here -->
                <!-- Initial message handled by JS renderChatHistory -->
            </div>
            <div id="quickActions" class="quick-actions">
                <!-- Quick action buttons will be added here by JS -->
            </div>
            <form id="chatInputForm" class="chat-input-form">
                <input type="text" id="chatInput" placeholder="Type your message...">
                <button type="submit" id="chatSendBtn">Send</button>
            </form>
        </div>
    </section>

    <main class="container">
        <section id="goal-setting">
            <h2>Set Your Horizon Goal</h2>
            <div class="form-group">
                <label for="goalName">What are you saving for?</label>
                <input type="text" id="goalName" placeholder="e.g., House Down Payment">
            </div>
            <div class="form-group">
                <label for="goalAmount">Target Amount (€):</label>
                <input type="number" id="goalAmount" min="0" step="0.01" value="0">
            </div>
            <div class="form-group">
                <label for="goalDate">By when do you want to achieve it?</label>
                <input type="date" id="goalDate">
            </div>
            <button id="saveGoalBtn">Set My Goal</button>
        </section>

        <section id="current-goal">
            <h2>Your Current Horizon</h2>
            <div id="goalDisplay" class="goal-display" style="display: none;">
                <p><strong>Goal:</strong> <span id="displayGoalName"></span></p>
                <p><strong>Target:</strong> €<span id="displayGoalAmount"></span> by <span id="displayGoalDate"></span></p>
                <p class="goal-impact">Projected Completion: <strong id="projectedGoalDate"></strong></p>
                <button id="editGoalBtn" style="margin-top: 15px;">Edit Goal</button>
            </div>
            <p id="noGoalMessage" class="no-goal">No horizon goal set yet. Set one above to begin your journey!</p>
        </section>

        <section id="add-event">
            <h2>Add a Future Life Event</h2>
            <div class="form-group">
                <label for="eventName">What is this event?</label>
                <input type="text" id="eventName" placeholder="e.g., Dream Vacation, Project Bonus">
            </div>
            <div class="form-group">
                <label for="eventType">Type:</label>
                <select id="eventType">
                    <option value="expense">Upcoming Expense</option>
                    <option value="income">Incoming Funds</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventAmount">Amount (€):</label>
                <input type="number" id="eventAmount" min="0" step="0.01" value="0">
            </div>
            <div class="form-group">
                <label for="eventDate">When will this happen?</label>
                <input type="date" id="eventDate">
            </div>
            <button id="addEventBtn">Add Event to Timeline</button>
        </section>

        <section id="timeline-view">
            <h2>Your Financial Timeline</h2>
            <ul id="eventList" class="event-list">
                <!-- Events will be dynamically added here -->
            </ul>
            <p id="noEventsMessage" class="no-events">No events added yet. Add some to see their impact!</p>
            <button id="resetAllDataBtn" style="background-color: var(--event-expense-color); margin-top: 30px;">Reset All Data</button>
        </section>
    </main>

    <!-- Custom Modal Structure -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" style="display: none;">Confirm</button>
                <button id="modalCancelBtn" style="display: none;">Cancel</button>
                <button id="modalOkBtn" style="display: none;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript Logic
        const goalNameInput = document.getElementById('goalName');
        const goalAmountInput = document.getElementById('goalAmount');
        const goalDateInput = document.getElementById('goalDate');
        const saveGoalBtn = document.getElementById('saveGoalBtn');
        const editGoalBtn = document.getElementById('editGoalBtn');

        const displayGoalName = document.getElementById('displayGoalName');
        const displayGoalAmount = document.getElementById('displayGoalAmount');
        const displayGoalDate = document.getElementById('displayGoalDate');
        const projectedGoalDate = document.getElementById('projectedGoalDate');
        const goalDisplayDiv = document.getElementById('goalDisplay');
        const noGoalMessage = document.getElementById('noGoalMessage');

        const eventNameInput = document.getElementById('eventName');
        const eventTypeInput = document.getElementById('eventType');
        const eventAmountInput = document.getElementById('eventAmount');
        const eventDateInput = document.getElementById('eventDate');
        const addEventBtn = document.getElementById('addEventBtn');
        const eventListUl = document.getElementById('eventList');
        const noEventsMessage = document.getElementById('noEventsMessage');
        const resetAllDataBtn = document.getElementById('resetAllDataBtn');

        const themeSelect = document.getElementById('themeSelect');

        // Modal Elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalOkBtn = document.getElementById('modalOkBtn');

        // Chat Elements
        const chatContainer = document.getElementById('chatContainer');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const quickActionsDiv = document.getElementById('quickActions');
        const languageSelect = document.getElementById('languageSelect'); // New language select

        let goal = null;
        let events = [];
        let editingEventIndex = -1;

        // Translations object for multilingual support
        const translations = {
            en: {
                greeting: "Hello! I'm your Revolut Assistant. How can I help you with your financial horizons today?",
                quickActions: [
                    { text: 'Set a Goal', message: 'How do I set a new Horizon Goal?' },
                    { text: 'Add an Event', message: 'I want to add a new financial event.' },
                    { text: 'View Timeline', message: 'Show me my financial timeline.' },
                    { text: 'Contact Support', message: 'I need to speak with a human agent.' }
                ],
                escalationMessage: "I understand this is an urgent matter. For immediate assistance with scams, fraud, or emergencies, please call our 24/7 support line at +353 1 800 123 456 (example number) or visit our dedicated security page at revolut.com/security (example URL). I am connecting you to a live agent for further assistance right away.",
                modalTitle: "Connecting You to Support",
                modalMessage: (time) => `Thanks, Margaret – your request has been received!\n\nMary from Customer Care will be with you shortly.\n(Timestamp: ${time})\n\nFor urgent issues, please use the provided contact details.`,
                loading: "Assistant is typing",
                apiError: "I'm sorry, I couldn't get a response right now. Please try again later.",
                networkError: "Oops! Something went wrong. Please check your internet connection or try again later."
            },
            es: {
                greeting: "¡Hola! Soy tu Asistente Revolut. ¿Cómo puedo ayudarte con tus horizontes financieros hoy?",
                quickActions: [
                    { text: 'Establecer una Meta', message: '¿Cómo establezco una nueva Meta de Horizonte?' },
                    { text: 'Añadir un Evento', message: 'Quiero añadir un nuevo evento financiero.' },
                    { text: 'Ver Cronograma', message: 'Muéstrame mi cronograma financiero.' },
                    { text: 'Contactar Soporte', message: 'Necesito hablar con un agente humano.' }
                ],
                escalationMessage: "Entiendo que este es un asunto urgente. Para asistencia inmediata con estafas, fraudes o emergencias, por favor llama a nuestra línea de soporte 24/7 al +353 1 800 123 456 (número de ejemplo) o visita nuestra página de seguridad dedicada en revolut.com/security (URL de ejemplo). Te estoy conectando con un agente en vivo para más asistencia de inmediato.",
                modalTitle: "Conectando con Soporte",
                modalMessage: (time) => `Gracias, Margaret – ¡tu solicitud ha sido recibida!\n\nMary de Atención al Cliente se pondrá en contacto contigo en breve.\n(Hora: ${time})\n\nPara asuntos urgentes, por favor utiliza los datos de contacto proporcionados.`,
                loading: "El asistente está escribiendo",
                apiError: "Lo siento, no pude obtener una respuesta en este momento. Por favor, inténtalo de nuevo más tarde.",
                networkError: "¡Ups! Algo salió mal. Por favor, revisa tu conexión a internet o inténtalo de nuevo más tarde."
            },
            bn: {
                greeting: "নমস্কার! আমি আপনার রেভোলুট অ্যাসিস্ট্যান্ট। আপনার আর্থিক দিগন্ত নিয়ে আজ আমি কিভাবে সাহায্য করতে পারি?",
                quickActions: [
                    { text: 'একটি লক্ষ্য সেট করুন', message: 'আমি কিভাবে একটি নতুন দিগন্তের লক্ষ্য সেট করব?' },
                    { text: 'একটি ইভেন্ট যোগ করুন', message: 'আমি একটি নতুন আর্থিক ইভেন্ট যোগ করতে চাই।' },
                    { text: 'সময়রেখা দেখুন', message: 'আমার আর্থিক সময়রেখা দেখান।' },
                    { text: 'সহায়তা কেন্দ্রে যোগাযোগ করুন', message: 'আমি একজন মানব এজেন্টের সাথে কথা বলতে চাই।' }
                ],
                escalationMessage: "আমি বুঝতে পারছি এটি একটি জরুরি বিষয়। কেলেঙ্কারি, জালিয়াতি বা জরুরি অবস্থার জন্য তাৎক্ষণিক সহায়তার জন্য, অনুগ্রহ করে আমাদের 24/7 সহায়তা লাইনে +353 1 800 123 456 (উদাহরণ নম্বর) এ কল করুন অথবা revolut.com/security (উদাহরণ URL) এ আমাদের ডেডিকেটেড নিরাপত্তা পৃষ্ঠা দেখুন। আমি আপনাকে অবিলম্বে আরও সহায়তার জন্য একজন লাইভ এজেন্টের সাথে সংযুক্ত করছি।",
                modalTitle: "সহায়তা কেন্দ্রের সাথে সংযোগ করা হচ্ছে",
                modalMessage: (time) => `ধন্যবাদ, মার্গারেট – আপনার অনুরোধ গৃহীত হয়েছে!\n\nগ্রাহক পরিষেবা থেকে মেরি শীঘ্রই আপনার সাথে যোগাযোগ করবেন।\n(সময়: ${time})\n\nজরুরি সমস্যার জন্য, অনুগ্রহ করে প্রদত্ত যোগাযোগের বিবরণ ব্যবহার করুন।`,
                loading: "অ্যাসিস্ট্যান্ট টাইপ করছে",
                apiError: "দুঃখিত, আমি এই মুহূর্তে একটি উত্তর পেতে পারিনি। অনুগ্রহ করে পরে আবার চেষ্টা করুন।",
                networkError: "ওহ! কিছু ভুল হয়েছে। অনুগ্রহ করে আপনার ইন্টারনেট সংযোগ পরীক্ষা করুন অথবা পরে আবার চেষ্টা করুন।"
            },
            zh: {
                greeting: "您好！我是您的 Revolut 助理。今天我能如何帮助您规划财务未来？",
                quickActions: [
                    { text: '设定目标', message: '我如何设定新的财务目标？' },
                    { text: '添加事件', message: '我想添加一个新的财务事件。' },
                    { text: '查看时间线', message: '显示我的财务时间线。' },
                    { text: '联系支持', message: '我需要与人工客服交谈。' }
                ],
                escalationMessage: "我理解这是一个紧急问题。如需诈骗、欺诈或紧急情况的即时帮助，请拨打我们的24/7支持热线 +353 1 800 123 456（示例号码）或访问我们的专用安全页面 revolut.com/security（示例网址）。我将立即为您转接人工客服以获得进一步帮助。",
                modalTitle: "正在连接至支持",
                modalMessage: (time) => `谢谢，玛格丽特 – 您的请求已收到！\n\n客户服务部的玛丽将很快与您联系。\n(时间戳: ${time})\n\n如遇紧急情况，请使用提供的联系方式。`,
                loading: "助理正在输入",
                apiError: "抱歉，暂时无法获取回复。请稍后再试。",
                networkError: "糟糕！出了些问题。请检查您的网络连接或稍后再试。"
            }
        };

        let currentLanguage = localStorage.getItem('horizonsLanguage') || 'en'; // Load saved language or default to English
        languageSelect.value = currentLanguage; // Set dropdown to current language

        // Initial system prompt for the AI assistant
        // This prompt is crucial for defining the AI's persona, capabilities, and escalation protocol.
        const getSystemPrompt = (lang) => {
            const langName = languageSelect.options[languageSelect.selectedIndex].text;
            return {
                role: "user",
                parts: [{ text: `You are Revolut Assistant, a dedicated, empathetic, and professional financial agent for 'Revolut Horizons'. Your primary goal is to empower users to manage their financial goals and events within this application.
**Your core capabilities include:**
1.  **Goal Management:** Explain how to set, view, or edit their Horizon Goal (e.g., 'How do I set a goal?', 'What is my current goal?').
2.  **Event Management:** Guide users on adding, editing, or deleting future Life Events (income or expenses) (e.g., 'How do I add an event?', 'Can I change an event?').
3.  **Financial Impact:** Clarify how their financial trajectory is impacted by their goals and events (e.g., 'How do events affect my goal?').
4.  **General Financial Concepts:** Provide simple, clear explanations about financial planning relevant to 'Horizons' (e.g., 'What is budgeting?', 'Why plan long-term?').
5.  **Proactive Assistance:** Based on the user's current goals and events (if provided in the context), offer relevant suggestions or insights.
**Multilingual Support:** You are capable of understanding and responding in multiple languages. The current user's preferred language is ${langName} (${lang} language code). Please respond *only* in ${langName}.
**CRITICAL ESCALATION PROTOCOL:**
If a user expresses a strong need to speak with a human, asks for a direct appointment, or uses keywords such as 'human', 'talk to someone', 'agent', 'appointment', 'schedule', 'speak to someone', 'customer service', 'urgent', 'scam', 'stolen', 'not working', 'emergency', 'fraud', 'compromised', 'report', you MUST gracefully escalate them to a human agent IMMEDIATELY.
**Escalation Message:** "I understand this is an urgent matter. For immediate assistance with scams, fraud, or emergencies, please call our 24/7 support line at +353 1 800 123 456 (example number) or visit our dedicated security page at revolut.com/security (example URL). I am connecting you to a live agent for further assistance right away. Please wait for a moment while our team reviews your request."
**Important:** Do NOT attempt to resolve complex personal financial issues, provide specific financial advice, or ask for sensitive personal information. Always maintain a warm, clear, and unambiguous tone. Avoid jargon. If a user asks something outside the scope of 'Horizons' or general financial planning, gently redirect them or offer to escalate if they seem frustrated. Keep responses concise and helpful.
`}]
            };
        };

        let chatHistory = []; // Initialize chatHistory as an empty array, will store only user/model messages

        let isHumanEscalated = false; // Flag to stop AI responses after escalation
        let isAILoading = false; // Flag to prevent multiple AI requests

        // --- Custom Modal Functions ---
        function showModal(title, message, type = 'alert', onConfirm = null, onCancel = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalConfirmBtn.style.display = 'none';
            modalCancelBtn.style.display = 'none';
            modalOkBtn.style.display = 'none';

            // Clear previous event listeners
            modalConfirmBtn.onclick = null;
            modalCancelBtn.onclick = null;
            modalOkBtn.onclick = null;

            if (type === 'confirm') {
                modalConfirmBtn.style.display = 'inline-block';
                modalCancelBtn.style.display = 'inline-block';
                modalConfirmBtn.onclick = () => {
                    hideModal();
                    if (onConfirm) onConfirm();
                };
                modalCancelBtn.onclick = () => {
                    hideModal();
                    if (onCancel) onCancel();
                };
            } else { // 'alert' type
                modalOkBtn.style.display = 'inline-block';
                modalOkBtn.onclick = () => {
                    hideModal();
                    if (onConfirm) onConfirm(); // Use onConfirm for OK button callback
                };
            }
            customModal.classList.add('visible');
        }

        function hideModal() {
            customModal.classList.remove('visible');
        }

        // --- LocalStorage Functions ---
        function saveToLocalStorage() {
            localStorage.setItem('horizonsGoal', JSON.stringify(goal));
            localStorage.setItem('horizonsEvents', JSON.stringify(events));
            localStorage.setItem('horizonsTheme', document.body.dataset.theme);
            // Save chatHistory directly as it now only contains user/model messages
            localStorage.setItem('horizonsChatHistory', JSON.stringify(chatHistory));
            localStorage.setItem('horizonsIsHumanEscalated', JSON.stringify(isHumanEscalated));
            localStorage.setItem('horizonsLanguage', currentLanguage); // Save current language
        }

        function loadFromLocalStorage() {
            const storedGoal = localStorage.getItem('horizonsGoal');
            const storedEvents = localStorage.getItem('horizonsEvents');
            const storedTheme = localStorage.getItem('horizonsTheme');
            const storedChatHistory = localStorage.getItem('horizonsChatHistory');
            const storedIsHumanEscalated = localStorage.getItem('horizonsIsHumanEscalated');
            const storedLanguage = localStorage.getItem('horizonsLanguage');

            if (storedGoal) {
                goal = JSON.parse(storedGoal);
                // Ensure date string is converted back to Date object for calculations
                if (goal && goal.targetDate) {
                    goal.targetDate = new Date(goal.targetDate);
                }
            }

            if (storedEvents) {
                events = JSON.parse(storedEvents);
                // Ensure date strings are converted back to Date objects
                events.forEach(event => {
                    if (event.date) {
                        event.date = new Date(event.date);
                    }
                });
            }

            if (storedTheme) {
                document.body.dataset.theme = storedTheme;
                themeSelect.value = storedTheme;
            }

            if (storedLanguage) {
                currentLanguage = storedLanguage;
                languageSelect.value = currentLanguage;
            }

            if (storedChatHistory) {
                // Load chat history directly into the array
                chatHistory = JSON.parse(storedChatHistory);
            } else {
                chatHistory = []; // Ensure it's empty if nothing was stored
            }

            if (storedIsHumanEscalated) {
                isHumanEscalated = JSON.parse(storedIsHumanEscalated);
            }
        }

        // --- Date Formatting Helper ---
        function formatDate(date) {
            if (!date) return 'N/A';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(date).toLocaleDateString(undefined, options);
        }

        // --- Goal Calculation Logic ---
        function calculateProjectedGoalDate() {
            if (!goal || !goal.targetAmount || !goal.targetDate) {
                projectedGoalDate.textContent = 'Set your goal to see impact.';
                return;
            }

            const initialGoalAmount = parseFloat(goal.targetAmount);
            const initialGoalDate = new Date(goal.targetDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const diffTimeInitial = initialGoalDate.getTime() - today.getTime();
            const initialDaysToGoal = diffTimeInitial / (1000 * 60 * 60 * 24);

            if (initialDaysToGoal <= 0) {
                projectedGoalDate.textContent = 'Goal date is in the past!';
                return;
            }

            let netEventImpact = 0;
            events.forEach(event => {
                if (event.type === 'income') {
                    netEventImpact += parseFloat(event.amount);
                } else if (event.type === 'expense') {
                    netEventImpact -= parseFloat(event.amount);
                }
            });

            const remainingAmountToSave = initialGoalAmount - netEventImpact;

            if (remainingAmountToSave <= 0) {
                projectedGoalDate.textContent = `Achieved! ${formatDate(today)}`;
                projectedGoalDate.style.color = 'var(--goal-impact-color)';
                return;
            }

            const assumedDailySavingRate = initialGoalAmount / initialDaysToGoal;

            if (assumedDailySavingRate <= 0) {
                projectedGoalDate.textContent = 'Cannot calculate impact (Zero/Negative Goal Amount).';
                return;
            }

            const newDaysToGoal = remainingAmountToSave / assumedDailySavingRate;
            const newProjectedDate = new Date(today.getTime() + newDaysToGoal * (1000 * 60 * 60 * 24));

            projectedGoalDate.textContent = formatDate(newProjectedDate);

            const diffDaysProjected = newProjectedDate.getTime() - initialGoalDate.getTime();
            const tenDaysInMs = 10 * (1000 * 60 * 60 * 24);

            if (Math.abs(diffDaysProjected) < tenDaysInMs) {
                projectedGoalDate.style.color = 'var(--goal-impact-color)'; // On track
            } else if (diffDaysProjected < 0) {
                projectedGoalDate.style.color = 'var(--event-income-color)'; // Earlier
            } else {
                projectedGoalDate.style.color = 'var(--event-expense-color)'; // Later
            }
        }

        // --- Render Functions ---
        function renderGoal() {
            if (goal) {
                displayGoalName.textContent = goal.name;
                displayGoalAmount.textContent = parseFloat(goal.targetAmount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                displayGoalDate.textContent = formatDate(goal.targetDate);
                goalDisplayDiv.style.display = 'block';
                editGoalBtn.style.display = 'inline-block';
                noGoalMessage.style.display = 'none';
                calculateProjectedGoalDate();
            } else {
                goalDisplayDiv.style.display = 'none';
                editGoalBtn.style.display = 'none';
                noGoalMessage.style.display = 'block';
            }
        }

        function renderEvents() {
            eventListUl.innerHTML = '';
            if (events.length === 0) {
                noEventsMessage.style.display = 'block';
                return;
            }
            noEventsMessage.style.display = 'none';

            events.sort((a, b) => new Date(a.date) - new Date(b.date));

            events.forEach((event, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add(event.type);
                listItem.innerHTML = `
                    <div class="event-details">
                        <strong>${event.name}</strong> (${formatDate(event.date)})
                    </div>
                    <span class="event-amount">${event.type === 'income' ? '+' : '-'}€${parseFloat(event.amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    <div class="event-actions">
                        <button class="edit-btn" data-index="${index}">&#x270E;</button> <!-- Edit icon -->
                        <button class="delete-btn" data-index="${index}">&#x2715;</button> <!-- Delete icon -->
                    </div>
                `;
                eventListUl.appendChild(listItem);
            });
            calculateProjectedGoalDate();
        }

        // --- Event Handlers ---
        saveGoalBtn.addEventListener('click', () => {
            const name = goalNameInput.value.trim();
            const amount = parseFloat(goalAmountInput.value);
            const date = goalDateInput.value;

            if (name && amount > 0 && date) {
                goal = {
                    name: name,
                    targetAmount: amount,
                    targetDate: new Date(date)
                };
                saveToLocalStorage();
                showModal('Goal Set!', 'Your Horizon Goal has been successfully set.', 'alert', renderGoal);
            } else {
                showModal('Input Error', 'Please fill in all goal details correctly (Goal name, Amount > 0, and Date).');
            }
        });

        editGoalBtn.addEventListener('click', () => {
            if (goal) {
                goalNameInput.value = goal.name;
                goalAmountInput.value = goal.targetAmount;
                // Format date for input type="date" (YYYY-MM-DD)
                const dateObj = new Date(goal.targetDate);
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                goalDateInput.value = `${year}-${month}-${day}`;

                showModal('Edit Goal', 'Modify your goal details above and click "Set My Goal" to update.', 'alert');
            }
        });

        addEventBtn.addEventListener('click', () => {
            const name = eventNameInput.value.trim();
            const type = eventTypeInput.value;
            const amount = parseFloat(eventAmountInput.value);
            const date = eventDateInput.value;

            if (name && amount >= 0 && date) {
                if (editingEventIndex === -1) {
                    // Add new event
                    events.push({
                        name: name,
                        type: type,
                        amount: amount,
                        date: new Date(date)
                    });
                    showModal('Event Added', 'Your event has been added to the timeline!', 'alert');
                } else {
                    // Update existing event
                    events[editingEventIndex] = {
                        name: name,
                        type: type,
                        amount: amount,
                        date: new Date(date)
                    };
                    showModal('Event Updated', 'Your event has been updated on the timeline!', 'alert');
                    editingEventIndex = -1; // Reset editing state
                    addEventBtn.textContent = 'Add Event to Timeline'; // Reset button text
                }
                saveToLocalStorage();
                renderEvents();
                // Clear form fields
                eventNameInput.value = '';
                eventAmountInput.value = '0';
                eventDateInput.value = '';
            } else {
                showModal('Input Error', 'Please fill in all event details correctly (Event name, Amount >= 0, and Date).');
            }
        });

        eventListUl.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                showModal('Confirm Deletion', 'Are you sure you want to remove this event?', 'confirm', () => {
                    events.splice(index, 1);
                    saveToLocalStorage();
                    renderEvents();
                    showModal('Event Removed', 'The event has been removed from your timeline.');
                });
            } else if (e.target.classList.contains('edit-btn')) {
                const index = parseInt(e.target.dataset.index);
                editingEventIndex = index;
                const eventToEdit = events[index];

                eventNameInput.value = eventToEdit.name;
                eventTypeInput.value = eventToEdit.type;
                eventAmountInput.value = eventToEdit.amount;
                // Format date for input type="date" (YYYY-MM-DD)
                const dateObj = new Date(eventToEdit.date);
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                eventDateInput.value = `${year}-${month}-${day}`;

                addEventBtn.textContent = 'Update Event';
                showModal('Edit Event', 'Modify the event details above and click "Update Event" to save changes.');
            }
        });

        resetAllDataBtn.addEventListener('click', () => {
            showModal('Confirm Reset', 'Are you sure you want to reset ALL your Horizons data? This cannot be undone.', 'confirm', () => {
                localStorage.clear();
                goal = null;
                events = [];
                chatHistory = []; // Reset chat history to empty
                isHumanEscalated = false; // Reset escalation flag
                editingEventIndex = -1;
                currentLanguage = 'en'; // Reset language to English
                languageSelect.value = 'en';
                renderGoal();
                renderEvents();
                renderChatHistory(); // Re-render chat to show initial bot message
                // Reset default date for inputs
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                goalDateInput.value = todayString;
                eventDateInput.value = todayString;
                showModal('Data Reset', 'All your Horizons data has been cleared.');
            });
        });

        // --- Chatbot Functions ---
        function addMessageToChat(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.textContent = message;
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Auto-scroll to latest message
        }

        function renderChatHistory() {
            chatMessagesDiv.innerHTML = ''; // Clear existing messages
            if (chatHistory.length === 0) {
                // Add initial bot message if history is empty
                addMessageToChat('bot', translations[currentLanguage].greeting);
            } else {
                chatHistory.forEach(msg => {
                    addMessageToChat(msg.role === 'user' ? 'user' : 'bot', msg.parts[0].text);
                });
            }
            renderQuickActions(); // Render quick actions after history
        }

        function renderQuickActions() {
            quickActionsDiv.innerHTML = ''; // Clear existing buttons
            const actions = translations[currentLanguage].quickActions;

            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.addEventListener('click', () => {
                    addMessageToChat('user', action.message);
                    getBotResponse(action.message);
                });
                quickActionsDiv.appendChild(button);
            });
        }

        // Function to get a summary of current financial data for the LLM
        function getFinancialSummary() {
            let summary = "\n**Current User Financial Data:**\n";
            if (goal) {
                summary += `- Goal: "${goal.name}" for €${parseFloat(goal.targetAmount).toLocaleString()} by ${formatDate(goal.targetDate)}.\n`;
            } else {
                summary += "- No Horizon Goal set yet.\n";
            }

            if (events.length > 0) {
                summary += "- Upcoming Events:\n";
                events.forEach(event => {
                    summary += `  - ${event.type === 'income' ? 'Income' : 'Expense'}: "${event.name}" of €${parseFloat(event.amount).toLocaleString()} on ${formatDate(event.date)}.\n`;
                });
            } else {
                summary += "- No Life Events added yet.\n";
            }
            return summary;
        }

        async function getBotResponse(userMessage) {
            if (isHumanEscalated || isAILoading) {
                console.log("Bot not responding: Human escalated or AI already loading.");
                return;
            }

            isAILoading = true;
            chatSendBtn.disabled = true; // Disable send button
            const loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('chat-loading-indicator');
            loadingIndicator.innerHTML = `${translations[currentLanguage].loading}<span>.</span><span>.</span><span>.</span>`;
            chatMessagesDiv.appendChild(loadingIndicator);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

            // Add user message to chat history immediately for context in subsequent calls
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            saveToLocalStorage(); // Save updated chat history immediately

            // Check for escalation keywords
            const lowerCaseMessage = userMessage.toLowerCase();
            const escalationKeywords = ['human', 'talk', 'agent', 'appointment', 'schedule', 'speak to someone', 'customer service', 'urgent', 'scam', 'stolen', 'not working', 'emergency', 'fraud', 'compromised', 'report', 'live chat'];
            const needsEscalation = escalationKeywords.some(keyword => lowerCaseMessage.includes(keyword));

            if (needsEscalation) {
                isHumanEscalated = true; // Set flag to prevent further AI responses
                saveToLocalStorage(); // Save escalation state

                chatMessagesDiv.removeChild(loadingIndicator);
                addMessageToChat('bot', translations[currentLanguage].escalationMessage);
                // Show the human escalation modal
                const now = new Date();
                const currentTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                showModal(
                    translations[currentLanguage].modalTitle,
                    translations[currentLanguage].modalMessage(currentTime)
                );
                isAILoading = false;
                chatSendBtn.disabled = false;
                return;
            }

            // If not escalating, proceed with LLM call
            try {
                const financialSummary = getFinancialSummary();

                // Construct the prompt for the LLM: System prompt first, then all chat history
                const chatHistoryForLLM = [
                    getSystemPrompt(currentLanguage), // Dynamic system prompt
                    { role: "user", parts: [{ text: financialSummary }] }, // Add financial summary as a user message for context
                    ...chatHistory // All user/model messages
                ];

                console.log("Sending to LLM:", JSON.stringify(chatHistoryForLLM, null, 2));

                const payload = { contents: chatHistoryForLLM };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("LLM Response:", JSON.stringify(result, null, 2));

                chatMessagesDiv.removeChild(loadingIndicator); // Remove loading indicator

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const botResponseText = result.candidates[0].content.parts[0].text;
                    addMessageToChat('bot', botResponseText);
                    chatHistory.push({ role: "model", parts: [{ text: botResponseText }] }); // Add bot response to local history
                    saveToLocalStorage(); // Save updated chat history
                } else {
                    addMessageToChat('bot', translations[currentLanguage].apiError);
                    console.error("Unexpected API response structure:", result);
                }
            } catch (error) {
                chatMessagesDiv.removeChild(loadingIndicator); // Always remove loading indicator on error
                addMessageToChat('bot', translations[currentLanguage].networkError);
                console.error("Error fetching AI response:", error);
            } finally {
                isAILoading = false;
                chatSendBtn.disabled = false;
                chatInput.focus(); // Focus input after response
            }
        }

        chatInputForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                addMessageToChat('user', userMessage); // Only add to display here
                chatInput.value = ''; // Clear input field
                getBotResponse(userMessage);
            }
        });

        // --- Language Switching ---
        languageSelect.addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            // When language changes, clear chat history and re-render with new greeting
            chatHistory = [];
            saveToLocalStorage(); // Save selected language and empty chat history
            renderChatHistory(); // Re-render chat with new language and initial greeting
            renderQuickActions(); // Re-render quick actions with new language
        });


        // --- Theme Switching ---
        themeSelect.addEventListener('change', (e) => {
            document.body.dataset.theme = e.target.value;
            saveToLocalStorage(); // Save selected theme
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            renderGoal();
            renderEvents();
            renderChatHistory(); // Ensure chat history is rendered with correct language on load

            // Set default date for goal and event to today if not loaded from storage
            if (!goalDateInput.value) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                goalDateInput.value = todayString;
                eventDateInput.value = todayString;
            }
        });
    </script>
</body>
</html>
